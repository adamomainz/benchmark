name: linux-benchmark-cuda
on:
  workflow_call:
    inputs:
      userbenchmark:
        required: true
        type: string
        description: Name of the benchmark
      userbenchmark-run-args:
        required: true
        type: string
        description: Userbenchmark run command line arguments
      workflow_run_id:
        required: true
        type: string
      workflow_run_attempt:
        required: true
        type: string
    secrets:
      HUGGING_FACE_HUB_TOKEN:
        required: false
        description: |
          HF auth token to avoid rate limits when downloading models or datasets from hub
      AWS_ACCESS_KEY_ID:
        required: true
        description: |
          AWS access token for S3 uploading
      AWS_SECRET_ACCESS_KEY:
        required: true
        description: |
          AWS secret access key for S3 uploading

jobs:
  # Run a specific userbenchmark with given arguments
  # Need to pass in userbenchmark name and arguments
  benchmark:
    # Don't run on forked repos
    if: github.repository_owner == 'pytorch'
    runs-on: [a100-runner]
    timeout-minutes: 1440 # 24 hours
    environment: docker-s3-upload
    env:
      BASE_CONDA_ENV: "torchbench"
      CONDA_ENV: "userbenchmark"
      SETUP_SCRIPT: "/workspace/setup_instance.sh"
      HUGGING_FACE_HUB_TOKEN: ${{ secrets.HUGGING_FACE_HUB_TOKEN }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
    steps:
      - name: Copy artifact and upload to Amazon S3
        env:
          WORKFLOW_RUN_ID: ${{ inputs.workflow_run_id }}
          WORKFLOW_RUN_ATTEMPT: ${{ inputs.workflow_run_attempt }}
        run: |
          echo ${{ inputs }}
